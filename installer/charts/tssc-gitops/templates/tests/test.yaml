---
{{- include "common.test" . }}
  containers:
{{- if .Values.argoCD.enabled }}
{{- $argoCD := .Values.argoCD }}
    #
    # Test the ArgoCD rollout status.
    #
    - name: {{ printf "argocd-%s" $argoCD.name }}
      image: registry.redhat.io/openshift4/ose-tools-rhel9
      env:
        - name: NAMESPACE
          value: {{ $argoCD.namespace }}
        - name: RESOURCE_TYPE
          value: "statefulset"
      command:
        - /scripts/test-rollout-status.sh
      args:
        - {{ printf "app.kubernetes.io/managed-by=%s" $argoCD.name | quote }}
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      securityContext:
        allowPrivilegeEscalation: false
    #
    # Tests the ArgoCD instance login.
    #
    - name: {{ printf "argocd-login-%s" $argoCD.name }}
      image: registry.redhat.io/openshift-gitops-1/argocd-rhel8@sha256:5bfc4686983f9c62107772d99d900efbcc38175afe621c40958035aa49bfa9ed
      env:
        - name: ARGOCD_HOSTNAME
          value: {{ include "argoCD.serverHostname" . }}
        - name: ARGOCD_USER
          value: admin
        - name: ARGOCD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "argoCD.secretClusterName" . }}
              key: admin.password
      workingDir: /home/argocd
      command:
        - /scripts/argocd-helper.sh
      args:
        - login
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      securityContext:
        runAsNonRoot: false
        allowPrivilegeEscalation: false
{{- end }}
