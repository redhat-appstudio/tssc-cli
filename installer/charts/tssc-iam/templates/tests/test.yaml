{{- if .Values.iam.enabled }}
---
{{- include "common.test" . }}
  containers:
    #
    # Tests the Keycloak rollout status.
    #
  {{- $keycloak := .Values.iam }}
  {{- $keycloakName := include "iam.name" . }}
  {{- $tpa := $keycloak.keycloakCR.trustedProfileAnalyzerRealm }}
  {{- $tas := $keycloak.keycloakCR.trustedArtifactSignerRealm }}
  {{- $rhdh := $keycloak.keycloakCR.rhdhRealm }}

    - name: {{ printf "keycloak-%s" $keycloakName }}
      image: registry.redhat.io/openshift4/ose-tools-rhel9
      env:
        - name: NAMESPACE
          value: {{ $keycloak.namespace }}
        - name: RESOURCE_TYPE
          value: "statefulset"
      command:
        - /scripts/test-rollout-status.sh
      args:
        - {{
            printf "app=keycloak,app.kubernetes.io/instance=%s"
              $keycloakName | quote
          }}
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      securityContext:
        allowPrivilegeEscalation: false
  {{- if or $tas.enabled $tpa.enabled $rhdh.enabled }}
    - name: realm-test
      image: registry.redhat.io/openshift4/ose-tools-rhel9
      env:
        - name: NAMESPACE
          value: {{ $keycloak.keycloakCR.namespace }}
      command:
        - /scripts/test-keycloakrealmimport.sh
      args:
        - {{ $keycloak.keycloakCR.realmsName }}
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      securityContext:
        allowPrivilegeEscalation: false
  {{- end }}
{{- end }}
